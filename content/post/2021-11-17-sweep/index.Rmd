---
title: The sweep operator
author: Edoardo Costantini
date: '2021-11-17'
slug: sweep
categories: ["Tutorials", "Drafts"]
tags: ["statistics", "regression"]
subtitle: ''
summary: ''
authors: []
lastmod: '2022-04-02T15:33:01+02:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
bibliography: references.bib
output:
  blogdown::html_page:
    toc: true
    toc_depth: 4
    number_sections: true
---

```{r set up, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}

# Packages and functions
source("sweepGoodnight.R") # main sweep function
library(ISR3)                  # for SWP functions
library(fastmatrix)            # alternative sweep

# Take the mtcars data
y <- mtcars[, "mpg"]
X <- mtcars[, -1]

# Create a few shorthands we will use
n <- nrow(X)
p <- ncol(X)

```

# Introduction

The sweep operator is commonly used in linear model computation.
It performs elementary row operations on a $p \times p$ matrix which happen to be particularly useful for the estimation of multivariate linear models.
Little and Rubin [-@littleRubin:2002 p148] defined it as follows:

> The sweep operator is defined for symmetric matrices as follows. A $p \times p$ symmetric matrix G is said to be swept on row and column k if it is replaced by another symmetric $p \times p$ matrix H with elements defined as follows:
> $$
> h_{kk} = -1/g_{kk}
> $$
> $$
> h_{jk} = h_{kj} = \frac{g_{jk}}{g_{kk}}, j \neq k
> $$
> $$
> h_{jl} = g_{jl} - \frac{g_{jk}g_{kl}}{g_{kk}}, j \neq k, l \neq k
> $$

In this post, I'm interested in exploring how we use the sweep operator in the estimation of the parameters of linear models.
What is important to note is that when we want to sweep a symmetric matrix G over the row and column k we are simply replacing the elements of G with the results of these three equations.
If you are interested in the details of these equations, I recommend reading the full sweep operator description in Schafer Little and the Original paper.

# Learn by coding

To understand the sweep operator we will use it to compute the regression coefficient of a multivariate linear model estimated on an example dataset.
For this post, we will work with the data used by Little and Rubin [-@littleRubin:2002 p152].

```{r load data}
# Load Little Rubin data -------------------------------------------------------

# Create data
  X <- as.data.frame(
          matrix(
                  data = c(7, 1, 11, 11, 7, 11, 3, 1, 2, 21, 1, 11, 10, 26,
                           29, 56, 31, 52, 55, 71 ,31, 54, 47, 40, 66, 68,
                           6, 15, 8, 8, 6, 9, 17, 22, 18, 4, 23, 9, 8,
                           60, 52, 20, 47, 33, 22,6,44,22,26,34,12,12,
                           78.5, 74.3, 104.3, 87.6, 95.9, 109.2, 102.7,
                           72.5, 93.1, 115.9, 83.8, 113.3, 109.4),
                  ncol = 5
          )
  )

# Store useful information
  n <- nrow(X)
  p <- ncol(X)
```

Let's take a quick look at the first rows of the data to get an idea of what we are working with.

```{r check X}
# Glace at the first 6 rows of the data
  head(X)
```

## Compute the augmented covariance matrix

The sweep operator gets us the regression coefficients of a multivairate linear model when applied to what is known as the augmented covariance matrix of the data $\Theta$.
This is a $(p+1) \times (p+1)$ matrix storing the covariance matrix and the means of the dataset.

$$
\Theta =
\begin{bmatrix}
-1 & \mu_1 & ... &\mu_p\\
\mu_1 & \sigma^2_1 & ... & \sigma_{1p}\\
... & ... & ... & ...\\
\mu_p & \sigma_{1p} & ... & \sigma^2_{pp}
\end{bmatrix}
$$

Starting from our dataset, we can obtain this matrix in just a few steps:

- **Augment the original data** with a column of 1s on the left
  ```{r augment X}
  # Obtain the augmented covariance matrix ---------------------------------------

  # Augment X
    X_aug <- cbind(int = 1, as.matrix(X))

  ```

  Check out how `X_aug` looks.

  ```{r check augment X}
  # Glance at the first 6 rows of X_aug
    head(X_aug)

  ```

- Compute the **augmented matrix of sufficient statistics $T$**.

  $T$ is the matrix having as elements the sum of the cross-products of the columns of `X_aug`.
  Since the first column of `X_aug` is a column of 1s, the first element of T is the number of rows in the data, the first column and rows store the sum of scores on each variable (sufficient statistics for the mean), and the other elements store the sum of products between the columns of `X` (sufficeint statistics for the covariance matrix of `X`).

  $$
  T =
  \begin{bmatrix}
  n & \sum{x_1} & ... & \sum{x_p}\\
  \sum{x_1} & \sum{x_1^2} & ... & \sum{x_1 x_p}\\
  ... & ... & ... & ...\\
  \sum{x_p} & \sum{x_1 x_p} & ... & \sum{x_p^2}
  \end{bmatrix}
  $$
  In R, we can compute it easily with the cross-product function

  ```{r compute T}
  # Compute the matrix of sufficient statistics (T matrix)
    Tmat <- crossprod(X_aug)

  ```


We will use the sweep operator to compute the regression coefficients of different multivairate linear models.

## Sweep operator functions in R

I can use mine and I can show other people's functions.

## Estimate multivariate linear models

First, let's compute this matrix based on the data we have at hand.
First, let's see how we would obtain these linear moldes in R with standard procedures.
Let's start by fitting an intercept only multivariate linear model.
Let's regress `V5` and `V4` on a vector of `1s`.

```{r mlm intercept only}
# Fit some multivariate linear models ------------------------------------------

# Multivariate intercept only model
  # Define the dvs
  dvs <- c("V5", "V4")

  # Complicated but flexible way of writing the formula
  formula_lm <- paste0("cbind(",
                       paste0(dvs, collapse = ", "),
                       ") ~ 1")

  # Fit the model with the MLM
  mlm0 <- lm(formula_lm, data = X)

  # Do it with sweep shortcut
  coef(mlm0)
  # sweepGoodnight(T0, 1)["int", dvs]
  # sweepGoodnight(G, 1)["int", dvs]
  # theta["int", dvs]


```

# TL;DR, just give me the code!
```{r TLDR, ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```

# References